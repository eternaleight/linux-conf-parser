# Linux sysctl.confãƒ‘ãƒ¼ã‚µ (è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ã‚µ)
![CleanShot 2024-10-10 at 15 10 52](https://github.com/user-attachments/assets/6b6ebb4e-9727-4b88-baff-0e0f5db71239)

ã“ã®Rustãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€`sysctl.conf`å½¢å¼ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã€ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’`FxHashMap`ã«æ ¼ç´ã™ã‚‹ãƒ‘ãƒ¼ã‚µã§ã™ã€‚æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«æ¢ç´¢ã—ã€`.conf`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§è§£æã—ã¾ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚„ç©ºè¡Œã‚’ç„¡è¦–ã—ã€ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

## æ©Ÿèƒ½

- **ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’è§£æ**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å†…ã®`key=value`å½¢å¼ã®è¡Œã‚’è§£æã—ã€`FxHashMap`ã«æ ¼ç´ã—ã¾ã™ã€‚
- **ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚­ãƒ¼ã«å¯¾å¿œ**: `key.subkey=value`ã®ã‚ˆã†ã«ãƒ‰ãƒƒãƒˆã§åŒºåˆ‡ã‚‰ã‚ŒãŸã‚­ãƒ¼ã‚’ã€ãƒã‚¹ãƒˆã•ã‚ŒãŸ`FxHashMap`ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
- **ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚„ç©ºè¡Œã‚’ç„¡è¦–**: `#`ã‚„`;`ã§å§‹ã¾ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚„ç©ºè¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚
- **å†å¸°çš„ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®`.conf`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ**: æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®`.conf`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: è¡Œã®å…ˆé ­ã«`-`ãŒã‚ã‚‹å ´åˆã€ãã®è¡Œã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã€ãã‚Œä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼ã¯`stderr`ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã®æº–å‚™

ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆã—ã€`.conf`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚

```
config/
â”œâ”€â”€ etc/
â”‚   â”œâ”€â”€ sysctl.conf
â”‚   â””â”€â”€ sysctl.d/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ sysctl.d/
â”œâ”€â”€ run/
â”‚   â””â”€â”€ sysctl.d/
â”œâ”€â”€ usr/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ sysctl.d/
â”‚   â””â”€â”€ local/
â”‚       â””â”€â”€ lib/
â”‚           â””â”€â”€ sysctl.d/
```

å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`.conf`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ã€ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’è¨˜è¿°ã§ãã¾ã™ã€‚

## ä½¿ç”¨æ–¹æ³•

### 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã®å½¢å¼ã§è¨˜è¿°ã—ã¾ã™ï¼š

```bash
# ã‚³ãƒ¡ãƒ³ãƒˆè¡Œ
key1=value1
key2.subkey=value2
key3.subkey1.subkey2=value3

; ã“ã¡ã‚‰ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆè¡Œ
```

- `#`ã‚„`;`ã§å§‹ã¾ã‚‹è¡Œã¯ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ç„¡è¦–ã•ã‚Œã¾ã™ã€‚
- `key=value`å½¢å¼ã®è¡Œã¯ã‚­ãƒ¼ã¨å€¤ã¨ã—ã¦è§£æã•ã‚Œã¾ã™ã€‚ãƒ‰ãƒƒãƒˆï¼ˆ`.`ï¼‰ã§åŒºåˆ‡ã‚‰ã‚ŒãŸã‚­ãƒ¼ã¯ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒãƒƒãƒ—ã¨ã—ã¦æ ¼ç´ã•ã‚Œã¾ã™ã€‚
- è¡Œã®å…ˆé ­ã«`-`ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã€è¨­å®šã®é©ç”¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç„¡è¦–ã•ã‚Œã¾ã™ã€‚

### 2. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œ

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
cargo run
```

å®Ÿè¡Œã™ã‚‹ã¨ã€æŒ‡å®šã•ã‚ŒãŸ`config`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®`.conf`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå†å¸°çš„ã«å‡¦ç†ã•ã‚Œã€ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢å¼ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
File: config/etc/sysctl.d/99-example.conf
fs
  file-max 2097152

net
  core
    somaxconn 1024
```

### 3. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æŒ‡å®š

`main`é–¢æ•°ã§ã¯ã€ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒªã‚¹ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ã“ã‚Œã‚‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ã‚ã‚‹`.conf`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```rust
let directories = [
    "config/etc/sysctl.d",
    "config/run/sysctl.d",
    "config/usr/local/lib/sysctl.d",
    "config/usr/lib/sysctl.d",
    "config/lib/sysctl.d",
    "config/etc",
    "config"
];
```

ã“ã®ãƒªã‚¹ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€èª­ã¿è¾¼ã¿ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚

### 4. ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- è¡Œã®å…ˆé ­ã«`-`ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã€ãã®è¡Œã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚
- è¨­å®šå€¤ãŒ4096æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã€è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã€ãã®è¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚

## 4096æ–‡å­—ã‚’è¶…ãˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
![CleanShot 2024-10-10 at 17 05 45](https://github.com/user-attachments/assets/8a47572a-1c58-4f44-9f87-a232bbcc9ee0)


ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€`value.too.long` ã«4096æ–‡å­—ã‚’è¶…ãˆã‚‹å€¤ãŒå«ã¾ã‚Œã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã éš›ã«ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ­£ã—ãã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã¦çµ‚äº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

### ä½¿ç”¨æ–¹æ³•

#### 1. ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ

ã¾ãšã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€`4096æ–‡å­—ã‚’è¶…ãˆã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«` ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

```sh
sh sh.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`config` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã« `long_value_test.conf` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€`value.too.long` ã‚­ãƒ¼ã«å¯¾ã—ã¦4096æ–‡å­—ã‚’è¶…ãˆã‚‹å€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

#### 2. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œ

æ¬¡ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
cargo run
```

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ `long_value_test.conf` ã‚’èª­ã¿è¾¼ã‚€ã¨ã€4096æ–‡å­—ã‚’è¶…ãˆã‚‹å€¤ãŒæ¤œå‡ºã•ã‚Œã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å‡ºåŠ›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```sh
Error: ã‚­ãƒ¼ 'value.too.long' ã®å€¤ãŒ4096æ–‡å­—ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ğŸ‘€
```

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã™ã‚‹ã¨ã€é©åˆ‡ã«çµ‚äº†ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é•·ã™ãã‚‹å€¤ãŒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒç•°å¸¸ãªæŒ™å‹•ã‚’é˜²ãã€é©åˆ‡ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã¦çµ‚äº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚



## é–¢æ•°ã®èª¬æ˜

#### `parse_sysctl_conf(file_path: &Path) -> io::Result<FxHashMap<String, FxHashMap<String, String>>>`

æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€å„è¡Œã‚’è§£æã—ã¦`FxHashMap`ã«æ ¼ç´ã—ã¾ã™ã€‚è¡Œã®å…ˆé ­ã«`-`ãŒã‚ã‚‹å ´åˆã€ãã®è¡Œã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚

#### `insert_nested_key(map: &mut FxHashMap<String, FxHashMap<String, String>>, key: &str, value: &str)`

`key.subkey=value`ã®ã‚ˆã†ã«ãƒ‰ãƒƒãƒˆã§åŒºåˆ‡ã‚‰ã‚ŒãŸã‚­ãƒ¼ã‚’ã€ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒãƒƒãƒ—ã«å¤‰æ›ã—ã¦æŒ¿å…¥ã—ã¾ã™ã€‚

#### `parse_all_sysctl_files(directories: &[&str]) -> io::Result<()>`

è¤‡æ•°ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«æ¢ç´¢ã—ã€ã™ã¹ã¦ã®`.conf`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚

## ä½¿ç”¨ä¾‹

### å…¥åŠ›ä¾‹ 1

`config/example1.conf`ãƒ•ã‚¡ã‚¤ãƒ«ï¼š

```bash
endpoint = localhost:3000
debug = true
log.file = /var/log/console.log
```

### å‡ºåŠ›ä¾‹ 1

```bash
File: config/example1.conf

endpoint localhost:3000
debug true
log
  file /var/log/console.log
```

### å…¥åŠ›ä¾‹ 2

`config/example2.conf`ãƒ•ã‚¡ã‚¤ãƒ«ï¼š

```bash
endpoint = localhost:3000
# debug = true
log.file = /var/log/console.log
log.name = default.log
```

### å‡ºåŠ›ä¾‹ 2

```bash
File: config/example2.conf

endpoint localhost:3000
log
  file /var/log/console.log
  name default.log
```


# Linux sysctl.confãƒ‘ãƒ¼ã‚µ (Mapå½¢å¼, JSONå½¢å¼å‡ºåŠ›Ver.)
![CleanShot 2024-10-09 at 22 00 02](https://github.com/user-attachments/assets/2f3e0561-4975-41bc-8627-38f2c1e19408)

ã“ã®Rustãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€`sysctl.conf` å½¢å¼ã«æº–æ‹ ã—ãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã€ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’`serde_json::Map`ã«æ ¼ç´ã—ã¦Mapå½¢å¼, JSONå½¢å¼ã§å‡ºåŠ›ã™ã‚‹ãƒ‘ãƒ¼ã‚µã§ã™ã€‚

ãƒªãƒã‚¸ãƒˆãƒª(serde-map-jsonãƒ–ãƒ©ãƒ³ãƒ)â†“
\
https://github.com/eternaleight/rust-projects/tree/serde-map-json

## ä¾‹

### å…¥åŠ›ä¾‹ 1

config/example1.conf

```bash
endpoint = localhost:3000
debug = true
log.file = /var/log/console.log
```

### å‡ºåŠ›ä¾‹ 1

ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ã€æ¬¡ã®ã‚ˆã†ã«Mapå½¢å¼, JSONå½¢å¼ã§å‡ºåŠ›ã•ã‚Œã¾ã™

```bash
File: config/example1.conf

{"debug": String("true"), "endpoint": String("localhost:3000"), "log": Object {"file": String("/var/log/console.log")}}
Map

{
  "debug": "true",
  "endpoint": "localhost:3000",
  "log": {
    "file": "/var/log/console.log"
  }
}
JSON

```

### å…¥åŠ›ä¾‹ 2

config/example2.conf

```bash
endpoint = localhost:3000
# debug = true
log.file = /var/log/console.log
log.name = default.log
```

### å‡ºåŠ›ä¾‹ 2

ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚`-` ãŒä»˜ã„ãŸ `kernel.hostname` ã¯ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç„¡è¦–ã•ã‚Œã¾ã™ã€‚

```bash
File: config/example2.conf

{"endpoint": String("localhost:3000"), "log": Object {"file": String("/var/log/console.log"), "name": String("default.log")}}
Map

{
  "endpoint": "localhost:3000",
  "log": {
    "file": "/var/log/console.log",
    "name": "default.log"
  }
}
JSON
```
